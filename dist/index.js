#!/usr/bin/env node
'use strict';

var _stringify = require('babel-runtime/core-js/json/stringify');

var _stringify2 = _interopRequireDefault(_stringify);

var _couchService = require('./couchService');

var _couchService2 = _interopRequireDefault(_couchService);

var _hexEncoder = require('./hexEncoder');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var config = require('config');
var winston = require('winston');
//import RestService from './restService'


// const restService = new RestService()

// Set up logging transports
var logFile = './logs/mfa-processor.log';
var logger = new winston.Logger({
    transports: [new winston.transports.Console(), new winston.transports.File({ filename: logFile })]
});
var watchedDatabaseList = [];

process.on('unhandledRejection', function (reason) {
    logger.log('error', 'DEBUG: Unhandled Rejection Reason', reason);
});
logger.log('info', 'START');

// Get the collection of databases to watch
var completedDatabase = new _couchService2.default('completed-visits');
completedDatabase.getUserDatabaseList().then(function (list) {
    start(list);
}).catch(function (err) {
    return logger.log('error', 'Error: Unable to fetch list of user databases', err);
});

// Store userdb instances in collection e.g. watchedDataBaseList[ 'userdb-xxxxxx', ... ]
var start = function start(watchList) {
    logger.log('info', 'Connected to ' + config.get('couchdb.remoteUrl'));
    watchList.forEach(function (d) {
        addWatchToDatabase(d);
    });
    watchForNewUsers();
    logger.log('info', 'MFA Processing Service Running...');
    // restService.start()
};

var addWatchToDatabase = function addWatchToDatabase(d) {
    watchedDatabaseList[d] = new _couchService2.default(d);
    watchedDatabaseList[d].subscribe(processChange, generalError);
    logger.log('info', 'Subscribed to', d);
};

var removeWatchFromDatabase = function removeWatchFromDatabase(d) {
    watchedDatabaseList[d].unsubscribe();
    watchedDatabaseList[d] = null;
    logger.log('info', 'Unsubscribed from', d);
};

// Add newly created user dbs to the watch list
var watchForNewUsers = function watchForNewUsers() {
    var success = function success(change) {
        change.forEach(function (c) {
            console.log(c.id);
            if (c.id.indexOf('org.couchdb.user:') > -1) {
                checkNameAgainstWatchList(c.id.replace('org.couchdb.user:', ''), c.deleted);
            }
        });
    };
    var error = function error(err) {
        logger.log('error', 'Error: Could not watch _users: ', (0, _stringify2.default)(err));
    };
    var users = new _couchService2.default('_users');
    users.subscribe(success, error, 'admin');
};

var checkNameAgainstWatchList = function checkNameAgainstWatchList(name, deleted) {
    var dbName = 'userdb-' + (0, _hexEncoder.hexEncode)(name);
    if (!deleted && watchedDatabaseList[dbName] === undefined) {
        addWatchToDatabase(dbName);
    }
    if (deleted && watchedDatabaseList[dbName] !== undefined) {
        removeWatchFromDatabase(dbName);
    }
};

// Ignore deleted records; [change] is always an array; 
// db is the database name, so we can remove doc later
var processChange = function processChange(change, db) {
    if (change) {
        change.forEach(function (c) {
            if (!c._deleted) {
                testForCompleted(c, db);
            }
        });
    }
};

// Filter only completed records
var testForCompleted = function testForCompleted(doc, db) {
    if (doc.status && doc.status === 'completed') {
        moveRecord(doc, db);
    }
};

// Move record into completed queue
var moveRecord = function moveRecord(doc, db) {
    var success = function success(doc) {
        removeIfNoError(doc.id, db);
    };
    var error = function error(err) {
        logger.log('error', 'Completed record could not be added:', (0, _stringify2.default)(err));
    };
    completedDatabase.add(doc, success, error);
};

// Ensure that record exists in completed database before removing
var removeIfNoError = function removeIfNoError(id, db) {
    var success = function success(doc) {
        remove(id, db);
    };
    var error = function error(err) {
        logger.log('error', 'Completed record ' + id + ' could not be found:', (0, _stringify2.default)(err));
    };
    completedDatabase.fetch(id, success, error);
};

var remove = function remove(id, db) {
    var success = function success(result) {
        logger.log('info', 'Assessment [' + id + '] was completed');
    };
    var error = function error(err) {
        logger.log('error', 'Completed record [' + id + '] could not be removed from', db, (0, _stringify2.default)(err));
    };
    watchedDatabaseList[db].remove(id, success, error);
};

var generalError = function generalError(err, database) {
    logger.log('error', database ? database : '', err);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJjb25maWciLCJyZXF1aXJlIiwid2luc3RvbiIsImxvZ0ZpbGUiLCJsb2dnZXIiLCJMb2dnZXIiLCJ0cmFuc3BvcnRzIiwiQ29uc29sZSIsIkZpbGUiLCJmaWxlbmFtZSIsIndhdGNoZWREYXRhYmFzZUxpc3QiLCJwcm9jZXNzIiwib24iLCJyZWFzb24iLCJsb2ciLCJjb21wbGV0ZWREYXRhYmFzZSIsImdldFVzZXJEYXRhYmFzZUxpc3QiLCJ0aGVuIiwic3RhcnQiLCJsaXN0IiwiY2F0Y2giLCJlcnIiLCJ3YXRjaExpc3QiLCJnZXQiLCJmb3JFYWNoIiwiYWRkV2F0Y2hUb0RhdGFiYXNlIiwiZCIsIndhdGNoRm9yTmV3VXNlcnMiLCJzdWJzY3JpYmUiLCJwcm9jZXNzQ2hhbmdlIiwiZ2VuZXJhbEVycm9yIiwicmVtb3ZlV2F0Y2hGcm9tRGF0YWJhc2UiLCJ1bnN1YnNjcmliZSIsInN1Y2Nlc3MiLCJjaGFuZ2UiLCJjb25zb2xlIiwiYyIsImlkIiwiaW5kZXhPZiIsImNoZWNrTmFtZUFnYWluc3RXYXRjaExpc3QiLCJyZXBsYWNlIiwiZGVsZXRlZCIsImVycm9yIiwidXNlcnMiLCJuYW1lIiwiZGJOYW1lIiwidW5kZWZpbmVkIiwiZGIiLCJfZGVsZXRlZCIsInRlc3RGb3JDb21wbGV0ZWQiLCJkb2MiLCJzdGF0dXMiLCJtb3ZlUmVjb3JkIiwicmVtb3ZlSWZOb0Vycm9yIiwiYWRkIiwicmVtb3ZlIiwiZmV0Y2giLCJyZXN1bHQiLCJkYXRhYmFzZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBR0E7Ozs7QUFFQTs7OztBQUpBLElBQU1BLFNBQVNDLFFBQVEsUUFBUixDQUFmO0FBQ0EsSUFBTUMsVUFBVUQsUUFBUSxTQUFSLENBQWhCO0FBRUE7OztBQUdBOztBQUVBO0FBQ0EsSUFBTUUsVUFBVSwwQkFBaEI7QUFDQSxJQUFNQyxTQUFTLElBQUtGLFFBQVFHLE1BQWIsQ0FBcUI7QUFDaENDLGdCQUFZLENBQ1IsSUFB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QWIsR0FBd0IsRUFBNUMsRUFBZ0RyQyxHQUFoRDtBQUFzRCxDQUFoRyIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbIlxyXG5jb25zdCBjb25maWcgPSByZXF1aXJlKCdjb25maWcnKVxyXG5jb25zdCB3aW5zdG9uID0gcmVxdWlyZSgnd2luc3RvbicpXHJcbmltcG9ydCBDb3VjaFNlcnZpY2UgZnJvbSAnLi9jb3VjaFNlcnZpY2UnXHJcbi8vaW1wb3J0IFJlc3RTZXJ2aWNlIGZyb20gJy4vcmVzdFNlcnZpY2UnXHJcbmltcG9ydCB7IGhleEVuY29kZSwgaGV4RGVjb2RlIH0gZnJvbSAnLi9oZXhFbmNvZGVyJ1xyXG5cclxuLy8gY29uc3QgcmVzdFNlcnZpY2UgPSBuZXcgUmVzdFNlcnZpY2UoKVxyXG5cclxuLy8gU2V0IHVwIGxvZ2dpbmcgdHJhbnNwb3J0c1xyXG5jb25zdCBsb2dGaWxlID0gJy4vbG9ncy9tZmEtcHJvY2Vzc29yLmxvZydcclxuY29uc3QgbG9nZ2VyID0gbmV3ICh3aW5zdG9uLkxvZ2dlcikoe1xyXG4gICAgdHJhbnNwb3J0czogW1xyXG4gICAgICAgIG5ldyAod2luc3Rvbi50cmFuc3BvcnRzLkNvbnNvbGUpKCksXHJcbiAgICAgICAgbmV3ICh3aW5zdG9uLnRyYW5zcG9ydHMuRmlsZSkoeyBmaWxlbmFtZTogbG9nRmlsZSB9KVxyXG4gICAgXVxyXG59KVxyXG5sZXQgd2F0Y2hlZERhdGFiYXNlTGlzdCA9IFtdXHJcblxyXG5wcm9jZXNzLm9uKCd1bmhhbmRsZWRSZWplY3Rpb24nLCAocmVhc29uKSA9PiB7XHJcbiAgICBsb2dnZXIubG9nKCdlcnJvcicsICdERUJVRzogVW5oYW5kbGVkIFJlamVjdGlvbiBSZWFzb24nLCByZWFzb24pO1xyXG59KTtcclxubG9nZ2VyLmxvZygnaW5mbycsICdTVEFSVCcpXHJcblxyXG4vLyBHZXQgdGhlIGNvbGxlY3Rpb24gb2YgZGF0YWJhc2VzIHRvIHdhdGNoXHJcbmxldCBjb21wbGV0ZWREYXRhYmFzZSA9IG5ldyBDb3VjaFNlcnZpY2UoJ2NvbXBsZXRlZC12aXNpdHMnKVxyXG5jb21wbGV0ZWREYXRhYmFzZS5nZXRVc2VyRGF0YWJhc2VMaXN0KClcclxuICAgIC50aGVuKGxpc3QgPT4geyBzdGFydChsaXN0KSB9KVxyXG4gICAgLmNhdGNoKGVyciA9PiBsb2dnZXIubG9nKCdlcnJvcicsICdFcnJvcjogVW5hYmxlIHRvIGZldGNoIGxpc3Qgb2YgdXNlciBkYXRhYmFzZXMnLCBlcnIpKVxyXG5cclxuLy8gU3RvcmUgdXNlcmRiIGluc3RhbmNlcyBpbiBjb2xsZWN0aW9uIGUuZy4gd2F0Y2hlZERhdGFCYXNlTGlzdFsgJ3VzZXJkYi14eHh4eHgnLCAuLi4gXVxyXG5jb25zdCBzdGFydCA9ICh3YXRjaExpc3QpID0+IHtcclxuICAgIGxvZ2dlci5sb2coJ2luZm8nLCAnQ29ubmVjdGVkIHRvICcgKyBjb25maWcuZ2V0KCdjb3VjaGRiLnJlbW90ZVVybCcpKVxyXG4gICAgd2F0Y2hMaXN0LmZvckVhY2goZCA9PiB7IGFkZFdhdGNoVG9EYXRhYmFzZShkKSB9KVxyXG4gICAgd2F0Y2hGb3JOZXdVc2VycygpXHJcbiAgICBsb2dnZXIubG9nKCdpbmZvJywgJ01GQSBQcm9jZXNzaW5nIFNlcnZpY2UgUnVubmluZy4uLicpXHJcbiAgICAvLyByZXN0U2VydmljZS5zdGFydCgpXHJcbn1cclxuXHJcbmNvbnN0IGFkZFdhdGNoVG9EYXRhYmFzZSA9IChkKSA9PiB7XHJcbiAgICB3YXRjaGVkRGF0YWJhc2VMaXN0W2RdID0gbmV3IENvdWNoU2VydmljZShkKVxyXG4gICAgd2F0Y2hlZERhdGFiYXNlTGlzdFtkXS5zdWJzY3JpYmUocHJvY2Vzc0NoYW5nZSwgZ2VuZXJhbEVycm9yKVxyXG4gICAgbG9nZ2VyLmxvZygnaW5mbycsICdTdWJzY3JpYmVkIHRvJywgZClcclxufVxyXG5cclxuY29uc3QgcmVtb3ZlV2F0Y2hGcm9tRGF0YWJhc2UgPSAoZCkgPT4ge1xyXG4gICAgd2F0Y2hlZERhdGFiYXNlTGlzdFtkXS51bnN1YnNjcmliZSgpXHJcbiAgICB3YXRjaGVkRGF0YWJhc2VMaXN0W2RdID0gbnVsbFxyXG4gICAgbG9nZ2VyLmxvZygnaW5mbycsICdVbnN1YnNjcmliZWQgZnJvbScsIGQpXHJcbn1cclxuXHJcbi8vIEFkZCBuZXdseSBjcmVhdGVkIHVzZXIgZGJzIHRvIHRoZSB3YXRjaCBsaXN0XHJcbmNvbnN0IHdhdGNoRm9yTmV3VXNlcnMgPSAoKSA9PiB7XHJcbiAgICBjb25zdCBzdWNjZXNzID0gKGNoYW5nZSkgPT4ge1xyXG4gICAgICAgIGNoYW5nZS5mb3JFYWNoKGMgPT4ge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhjLmlkKVxyXG4gICAgICAgICAgICBpZiAoYy5pZC5pbmRleE9mKCdvcmcuY291Y2hkYi51c2VyOicpID4gLTEpIHtcclxuICAgICAgICAgICAgICAgIGNoZWNrTmFtZUFnYWluc3RXYXRjaExpc3QoYy5pZC5yZXBsYWNlKCdvcmcuY291Y2hkYi51c2VyOicsICcnKSwgYy5kZWxldGVkKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgIH1cclxuICAgIGNvbnN0IGVycm9yID0gKGVycikgPT4geyBsb2dnZXIubG9nKCdlcnJvcicsICdFcnJvcjogQ291bGQgbm90IHdhdGNoIF91c2VyczogJywgSlNPTi5zdHJpbmdpZnkoZXJyKSkgfVxyXG4gICAgY29uc3QgdXNlcnMgPSBuZXcgQ291Y2hTZXJ2aWNlKCdfdXNlcnMnKVxyXG4gICAgdXNlcnMuc3Vic2NyaWJlKHN1Y2Nlc3MsIGVycm9yLCAnYWRtaW4nKVxyXG59XHJcblxyXG5jb25zdCBjaGVja05hbWVBZ2FpbnN0V2F0Y2hMaXN0ID0gKG5hbWUsIGRlbGV0ZWQpID0+IHtcclxuICAgIGxldCBkYk5hbWUgPSAndXNlcmRiLScgKyBoZXhFbmNvZGUobmFtZSlcclxuICAgIGlmICghZGVsZXRlZCAmJiAod2F0Y2hlZERhdGFiYXNlTGlzdFtkYk5hbWVdID09PSB1bmRlZmluZWQpKSB7XHJcbiAgICAgICAgYWRkV2F0Y2hUb0RhdGFiYXNlKGRiTmFtZSlcclxuICAgIH1cclxuICAgIGlmIChkZWxldGVkICYmICh3YXRjaGVkRGF0YWJhc2VMaXN0W2RiTmFtZV0gIT09IHVuZGVmaW5lZCkpIHtcclxuICAgICAgICByZW1vdmVXYXRjaEZyb21EYXRhYmFzZShkYk5hbWUpXHJcbiAgICB9XHJcbn1cclxuXHJcbi8vIElnbm9yZSBkZWxldGVkIHJlY29yZHM7IFtjaGFuZ2VdIGlzIGFsd2F5cyBhbiBhcnJheTsgXHJcbi8vIGRiIGlzIHRoZSBkYXRhYmFzZSBuYW1lLCBzbyB3ZSBjYW4gcmVtb3ZlIGRvYyBsYXRlclxyXG5jb25zdCBwcm9jZXNzQ2hhbmdlID0gKGNoYW5nZSwgZGIpID0+IHtcclxuICAgIGlmIChjaGFuZ2UpIHtcclxuICAgICAgICBjaGFuZ2UuZm9yRWFjaChjID0+IHtcclxuICAgICAgICAgICAgaWYgKCFjLl9kZWxldGVkKSB7IHRlc3RGb3JDb21wbGV0ZWQoYywgZGIpIH1cclxuICAgICAgICB9KVxyXG4gICAgfVxyXG59XHJcblxyXG4vLyBGaWx0ZXIgb25seSBjb21wbGV0ZWQgcmVjb3Jkc1xyXG5jb25zdCB0ZXN0Rm9yQ29tcGxldGVkID0gKGRvYywgZGIpID0+IHtcclxuICAgIGlmIChkb2Muc3RhdHVzICYmIChkb2Muc3RhdHVzID09PSAnY29tcGxldGVkJykpIHsgbW92ZVJlY29yZChkb2MsIGRiKSB9XHJcbn1cclxuXHJcbi8vIE1vdmUgcmVjb3JkIGludG8gY29tcGxldGVkIHF1ZXVlXHJcbmNvbnN0IG1vdmVSZWNvcmQgPSAoZG9jLCBkYikgPT4ge1xyXG4gICAgY29uc3Qgc3VjY2VzcyA9IChkb2MpID0+IHsgcmVtb3ZlSWZOb0Vycm9yKGRvYy5pZCwgZGIpIH1cclxuICAgIGNvbnN0IGVycm9yID0gKGVycikgPT4ge1xyXG4gICAgICAgIGxvZ2dlci5sb2coJ2Vycm9yJywgJ0NvbXBsZXRlZCByZWNvcmQgY291bGQgbm90IGJlIGFkZGVkOicsIEpTT04uc3RyaW5naWZ5KGVycikpXHJcbiAgICB9XHJcbiAgICBjb21wbGV0ZWREYXRhYmFzZS5hZGQoZG9jLCBzdWNjZXNzLCBlcnJvcilcclxufVxyXG5cclxuLy8gRW5zdXJlIHRoYXQgcmVjb3JkIGV4aXN0cyBpbiBjb21wbGV0ZWQgZGF0YWJhc2UgYmVmb3JlIHJlbW92aW5nXHJcbmNvbnN0IHJlbW92ZUlmTm9FcnJvciA9IChpZCwgZGIpID0+IHtcclxuICAgIGNvbnN0IHN1Y2Nlc3MgPSAoZG9jKSA9PiB7IHJlbW92ZShpZCwgZGIpIH1cclxuICAgIGNvbnN0IGVycm9yID0gKGVycikgPT4ge1xyXG4gICAgICAgIGxvZ2dlci5sb2coJ2Vycm9yJywgJ0NvbXBsZXRlZCByZWNvcmQgJyArIGlkICsgJyBjb3VsZCBub3QgYmUgZm91bmQ6JywgSlNPTi5zdHJpbmdpZnkoZXJyKSlcclxuICAgIH1cclxuICAgIGNvbXBsZXRlZERhdGFiYXNlLmZldGNoKGlkLCBzdWNjZXNzLCBlcnJvcilcclxufVxyXG5cclxuY29uc3QgcmVtb3ZlID0gKGlkLCBkYikgPT4ge1xyXG4gICAgY29uc3Qgc3VjY2VzcyA9IChyZXN1bHQpID0+IHtcclxuICAgICAgICBsb2dnZXIubG9nKCdpbmZvJywgJ0Fzc2Vzc21lbnQgWycgKyBpZCArICddIHdhcyBjb21wbGV0ZWQnKVxyXG4gICAgfVxyXG4gICAgY29uc3QgZXJyb3IgPSAoZXJyKSA9PiB7XHJcbiAgICAgICAgbG9nZ2VyLmxvZygnZXJyb3InLCAnQ29tcGxldGVkIHJlY29yZCBbJyArIGlkICsgJ10gY291bGQgbm90IGJlIHJlbW92ZWQgZnJvbScsIGRiLCBKU09OLnN0cmluZ2lmeShlcnIpKVxyXG4gICAgfVxyXG4gICAgd2F0Y2hlZERhdGFiYXNlTGlzdFtkYl0ucmVtb3ZlKGlkLCBzdWNjZXNzLCBlcnJvcilcclxufVxyXG5cclxuY29uc3QgZ2VuZXJhbEVycm9yID0gKGVyciwgZGF0YWJhc2UpID0+IHsgbG9nZ2VyLmxvZygnZXJyb3InLCAoZGF0YWJhc2UpID8gZGF0YWJhc2UgOiAnJywgZXJyKSB9XHJcbiJdfQ==